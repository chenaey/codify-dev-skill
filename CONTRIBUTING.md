# Codify Skill 协作与迭代指南

本文档定义 Skill 的协作模式、迭代流程和文档管理规范。

---

## 文档体系

```
skill/codify-skill/
├── SKILL.md                 # 入口：工作流程、核心原则
├── CONTRIBUTING.md          # 本文档：协作模式、迭代流程
├── ISSUES.md                # 问题追踪：待处理/已解决
├── references/
│   ├── codegen-rules.md     # 代码生成规范
│   ├── design-schema.md     # JSON 数据结构
│   └── api.md               # API 接口文档
└── scripts/
    └── download-assets.cjs  # 资源下载脚本
```

### 文档职责与关联

| 文档                 | 职责                       | 何时更新            | 关联文档          |
| -------------------- | -------------------------- | ------------------- | ----------------- |
| **SKILL.md**         | AI 执行入口，定义工作流程  | 流程变更时          | → references/\*   |
| **CONTRIBUTING.md**  | 协作规范，迭代指南         | 流程/协作模式调整时 | → ISSUES.md       |
| **ISSUES.md**        | 问题追踪，记录待办和已解决 | 发现/解决问题时     | ← CONTRIBUTING.md |
| **design-schema.md** | JSON 结构说明              | 数据结构变更时      | ← SKILL.md        |
| **api.md**           | API 接口详情               | 接口变更时          | ← SKILL.md        |
| **codegen-rules.md** | 代码生成细节               | 发现生成问题时      | ← SKILL.md        |

---

## 迭代流程

每次改进都遵循以下闭环：

```
┌─────────────────────────────────────────────────────────────────┐
│                        完整迭代闭环                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 发现问题                                                     │
│     └── 来源：用户反馈 / AI 自检 / 代码审查                       │
│                                                                 │
│  2. 记录 Issue                                                  │
│     └── 更新 ISSUES.md「待处理问题」                             │
│                                                                 │
│  3. 分析定位                                                     │
│     ├── Skill 层？→ 规则/流程问题                                │
│     └── 插件层？→ 数据结构/算法问题                              │
│                                                                 │
│  4. 设计方案                                                     │
│     ├── 参考 MCP 等开源实现                                      │
│     └── 与用户讨论确认                                           │
│                                                                 │
│  5. 实现变更                                                     │
│     ├── 代码修改                                                 │
│     └── 类型更新                                                 │
│                                                                 │
│  6. 验证测试                                                     │
│     └── 实际 JSON 输出对比                                       │
│                                                                 │
│  7. 更新文档（按需）                                             │
│     ├── design-schema.md ← 数据结构变更                          │
│     ├── api.md ← 接口变更                                        │
│     ├── SKILL.md ← 流程变更                                      │
│     └── codegen-rules.md ← 生成规则变更                          │
│                                                                 │
│  8. 关闭 Issue                                                  │
│     └── 移动到 ISSUES.md「已解决问题」                           │
│                                                                 │
│  9. 更新版本记录                                                 │
│     └── CONTRIBUTING.md 版本记录表                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Issue 管理

### Issue 状态流转

```
待处理 → 分析中 → 实现中 → 已解决
   │         │         │
   └─────────┴─────────┴──→ 暂缓（需更多信息/低优先级）
```

### Issue 模板

````markdown
### [序号]. [问题标题] ⭐ [优先级]

**问题文件**: `path/to/file.ts`

**问题描述**:
[描述现象和影响]

**当前行为**:

```json
{ "示例": "当前输出" }
```
````

**期望行为**:

```json
{ "示例": "期望输出" }
```

**参考方案**:

- [可选：参考 MCP 或其他项目的做法]

**状态**: 🔴 待处理 / 🟡 分析中 / 🟢 已解决

```

### 优先级定义

| 优先级 | 标记 | 定义 | 示例 |
|-------|------|------|------|
| 高 | ⭐⭐⭐ | 阻塞核心功能 | 节点被丢弃、样式丢失 |
| 中 | ⭐⭐ | 影响效率或体验 | 数据冗余、结构复杂 |
| 低 | ⭐ | 优化类改进 | 命名不规范、文档不清晰 |

---

## 问题分层

### Skill 层 vs 插件层

| 层级 | 职责 | 典型问题 | 解决方式 |
|------|------|---------|---------|
| **Skill 层** | 规则、流程、代码生成 | AI 未按规则使用数据 | 更新 Skill 文档 |
| **插件层** | 数据提取、结构转换 | 数据缺失或冗余 | 修改插件代码 |

### 插件层问题维度

| 维度 | 说明 | 相关文件 |
|------|------|---------|
| **结构解析** | 节点树层级、嵌套 | `uiExtractor.ts` |
| **样式提取** | customStyle 完整性 | `styleExtractor.ts` |
| **布局算法** | layoutMode、间距 | `layoutExtractor.ts` |
| **资源导出** | 图标、图片识别 | `iconExtractor.ts` |
| **语义描述** | 类型标注、命名 | `uiExtractor.ts` |

---

## 探索式开发

当需要较大改动时，采用探索式开发流程。

### 参考项目

| 项目 | 用途 | 位置 |
|------|------|------|
| **Figma-Context-MCP** | 数据结构设计参考 | `test/Figma-Context-MCP/` |

### 探索步骤

1. **发现问题** → 记录到 ISSUES.md
2. **参考 MCP** → 查看 `test/Figma-Context-MCP/src/`
3. **设计方案** → 与用户讨论确认
4. **实现验证** → 对比 JSON 输出
5. **更新文档** → 同步所有相关文档
6. **关闭 Issue** → 记录解决方案

### MCP 代码阅读要点

| 目录 | 关注点 |
|------|--------|
| `extractors/` | 节点类型判断、数据提取 |
| `types/` | 输出数据结构定义 |
| `simplifiers/` | 数据简化策略 |

---

## 协作角色

| 角色 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **用户** | 提供设计稿、验证、反馈 | 设计节点、截图、意见 | 问题描述、优化建议 |
| **AI Agent** | 获取数据、生成代码、迭代改进 | 截图 + JSON | 代码、文档更新 |
| **Skill 文档** | 规范流程、约束行为 | 协作经验 | 规则、检查清单 |

---

## Skill 优化原则

### 定位

**codify-skill 是设计稿还原工具，不是特定框架的代码生成器。**

| ✅ 正确定位 | ❌ 错误定位 |
|------------|-----------|
| 从 JSON + 截图还原设计到任意框架 | Vue/React 代码生成器 |
| 框架无关的布局和样式还原 | 特定框架的最佳实践教程 |
| 提供设计数据，由模型决定实现方式 | 规定死每种情况的处理方法 |

### 1. 信任模型能力

**假设模型很聪明**——只提供模型不具备的信息。

```
❌ "Flex 布局时，如果 justifyContent 是 space-between，则子元素会..."
✅ "从 layout.mode 和 layout.justifyContent 提取布局属性"
```

| 模型已知 | 模型未知 |
|---------|---------|
| CSS、HTML、各种框架语法、布局原理 | JSON 结构、API 端点、设计平台特有概念 |

### 2. 框架无关

描述**如何从设计数据中提取信息**，而非**如何写某个框架的代码**。

```
❌ "Vue 组件用 <script setup>，React 用函数组件..."
✅ "从 customStyle 提取样式，从 text.content 提取文本"
```

### 3. 数据驱动

| 数据来源 | 用途 | 禁止用途 |
|---------|------|---------|
| 截图 | 理解布局层级、组件边界 | 提取颜色、尺寸、字体 |
| JSON | 精确样式值、文本内容 | — |

### 4. 简洁优先

```
❌ 大段解释 + 多种情况分析
✅ 一条规则 + 必要时一个示例
```

**每条规则都要问：这值得占用 context window 吗？**

### 常见错误

| 错误类型 | 示例 |
|---------|------|
| 过度规定实现细节 | ❌ "弹窗关闭按钮应使用 position: absolute; top: 12px;" |
| 假设特定框架 | ❌ "使用 v-for 遍历列表项" |
| 解释模型已知知识 | ❌ "Flex 容器的 gap 属性用于设置子元素间距..." |
| 流程顺序冲突 | ❌ Step 1: 判断复杂度 Step 2: 获取截图 |

### 迭代检查清单

更新 skill 时，检查：

- [ ] 是否保持框架无关？
- [ ] 是否信任模型能力，不解释已知知识？
- [ ] 是否用表格/清单代替长文？
- [ ] 流程顺序是否有逻辑冲突？
- [ ] 信息是否只在一处定义？

---

## 版本记录

| 版本 | 改进内容 | 关联 Issue |
|------|---------|-----------|
| v1.0 | 基础工作流程 | - |
| v1.1 | 明确截图 vs JSON 职责分工 | - |
| v1.2 | 重构问题排查工作流 | - |
| v1.3 | 强制截图先行；记录根节点 ID 缺失 | #rootNodeId |
| v1.4 | API 返回 `rootNodeId` 字段 | ✅ #rootNodeId |
| v1.5 | 新增探索式开发流程 | - |
| v1.6 | Icon 类型重构：类型切换 + assets 聚合 | ✅ #vector-redundancy |
| v1.7 | 重构文档体系，完善迭代闭环 | - |
| v1.8 | 新增「状态切换尺寸稳定性」规则；补充绝对定位问题案例 | ✅ #border-size-jump |
| v1.9 | 完善响应式规则：宽度继承链、box-sizing、max-width 约束 | ✅ #responsive-rules |
| v2.0 | 新增「交互状态规则」：区分行为推断（允许）和样式推断（谨慎） | ✅ #interaction-style |
| v2.1 | 强化「图标资源」规则：禁止自行实现，必须从 assets 导出 | ✅ #icon-assets |
| v2.2 | 新增「组件规划」原则：复合页面先规划再实现，原子组件直接实现 | ✅ #component-planning |
| v2.3 | V7 Inline Compression：重复节点压缩，性能优化 | ✅ #large-design-optimization |
| v2.3.1 | 压缩优化：内容感知哈希 + 连续性检测 + GROUP 豁免 | ✅ #compression-refinement |
| v2.4 | 选中节点 UI 响应优化：防抖 + 缓存 + 过时请求取消 | ✅ #selection-lag |
| v2.5 | 强化组件规划：复合页面必须先输出规划清单；新增样式提取检查清单；代码质量基本要求 | #component-planning-enforce, #style-precision, #code-syntax |
| v2.6 | 文档精简优化：按 skill-creator 原则精简冗余规则，移除"跳转"概念，信任模型推理能力 | #complex-workflow-enforce, #image-resources |
| v2.7 | **强制拆分组件**：3-Phase 流程 + 检查点机制，禁止一次性生成复杂页面 | ✅ #component-split-enforcement |

---

## 快速参考

### 发现问题时

1. 检查 ISSUES.md 是否已记录
2. 若无，按模板添加到「待处理问题」
3. 标记优先级

### 解决问题后

1. 代码修改 + 测试验证
2. 更新相关文档（按需）
3. 移动 Issue 到「已解决问题」
4. 更新版本记录

### 文档更新检查清单

- [ ] 数据结构变更 → `design-schema.md`
- [ ] API 变更 → `api.md`
- [ ] 流程变更 → `SKILL.md`
- [ ] 生成规则变更 → `codegen-rules.md`
- [ ] 问题状态 → `ISSUES.md`
- [ ] 版本记录 → `CONTRIBUTING.md`
```